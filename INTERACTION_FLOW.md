# OnBeat合拍 - 完整交互流程图

## 1. 用户认证流程

```mermaid
graph TD
    A[访问应用] --> B{是否已登录?}
    B -->|否| C[登录/注册页面]
    B -->|是| D[首页]

    C --> C1[邮箱/用户名登录]
    C --> C2[微信登录]
    C --> C3[注册新账号]

    C1 --> C1A[输入账号密码]
    C1A --> C1B[验证身份]
    C1B -->|成功| C1C[获取JWT Token]
    C1C --> D
    C1B -->|失败| C1D[显示错误信息]
    C1D --> C1

    C2 --> C2A{设备类型?}
    C2A -->|PC| C2B[显示二维码]
    C2A -->|移动端| C2C[跳转微信授权]
    C2B --> C2D[微信扫码授权]
    C2C --> C2D
    C2D --> C2E[获取OpenID]
    C2E --> C2F{用户是否存在?}
    C2F -->|是| C2G[关联账号]
    C2F -->|否| C2H[创建新用户]
    C2G --> C1C
    C2H --> C1C

    C3 --> C3A[填写注册信息]
    C3A --> C3B[验证信息]
    C3B -->|成功| C3C[创建账号]
    C3C --> C1C
    C3B -->|失败| C3D[显示错误]
    C3D --> C3A
```

## 2. 首页浏览流程

```mermaid
graph TD
    A[首页] --> B[Tab导航]

    B --> B1[推荐Tab]
    B --> B2[歌手热歌Tab]
    B --> B3[好友动态Tab]
    B --> B4[最新歌曲Tab]

    B1 --> B1A[热门歌曲列表]
    B1A --> B1B[歌曲卡片]
    B1B --> B1C[点击播放]
    B1B --> B1D[点击分享]
    B1B --> B1E[点击卡片]

    B1C --> P[播放器组件]
    B1D --> S[分享弹窗]
    B1E --> SD[歌曲详情页]

    B2 --> B2A[歌手列表]
    B2A --> B2B[点击歌手]
    B2B --> B2C{展开状态?}
    B2C -->|已展开| B2D[收起歌曲列表]
    B2C -->|未展开| B2E[展开歌曲列表]
    B2E --> B2F[显示歌手简介]
    B2E --> B2G[显示热门歌曲]
    B2G --> B1B

    B3 --> B3A[好友动态列表]
    B3A --> B3B[好友播放/点赞记录]
    B3B --> B3C[点击用户]
    B3B --> B3D[点击歌曲]
    B3B --> B3E[点击私信]
    B3C --> UP[用户详情页]
    B3D --> SD
    B3E --> M[私信页面]

    B4 --> B4A[最新歌曲列表]
    B4A --> B1B
```

## 3. 歌曲详情页流程

```mermaid
graph TD
    A[歌曲详情页] --> B[歌曲信息区]
    A --> C[评论区]

    B --> B1[封面/标题/歌手]
    B --> B2[统计数据]
    B --> B3[操作按钮]

    B3 --> B3A[播放按钮]
    B3 --> B3B[点赞按钮]
    B3A --> P[播放器]
    B3B --> B3C{是否已点赞?}
    B3C -->|是| B3D[取消点赞]
    B3C -->|否| B3E[点赞]
    B3D --> B3F[更新点赞数]
    B3E --> B3F

    C --> C1[发表评论区]
    C --> C2[评论列表]

    C1 --> C1A[输入评论内容]
    C1A --> C1B[点击发表]
    C1B --> C1C[提交评论]
    C1C --> C1D[刷新评论列表]

    C2 --> C2A[评论项]
    C2A --> C2B[点赞评论]
    C2A --> C2C[回复评论]
    C2A --> C2D[查看回复]
    C2A --> C2E[私信作者]

    C2B --> C2F{是否已点赞?}
    C2F -->|是| C2G[取消点赞]
    C2F -->|否| C2H[点赞]
    C2G --> C2I[更新点赞数]
    C2H --> C2I

    C2C --> C2J[展开回复输入框]
    C2J --> C2K[输入回复内容]
    C2K --> C2L[发送回复]
    C2L --> C1D

    C2D --> C2M{展开状态?}
    C2M -->|已展开| C2N[折叠回复列表]
    C2M -->|未展开| C2O[展开回复列表]
    C2O --> C2P[显示所有回复]
    C2P --> C2Q[回复项]
    C2Q --> C2C

    C2E --> M[私信页面]
```

## 4. 用户详情页流程

```mermaid
graph TD
    A[用户详情页] --> B[用户信息]
    A --> C[操作按钮]
    A --> D[用户内容]

    B --> B1[头像/昵称]
    B --> B2[简介]
    B --> B3[统计数据]
    B3 --> B3A[关注数]
    B3 --> B3B[粉丝数]

    C --> C1{是否本人?}
    C1 -->|是| C2[编辑资料]
    C1 -->|否| C3[关注/取关]
    C1 -->|否| C4[发私信]

    C2 --> C2A[跳转个人资料页]

    C3 --> C3A{关注状态?}
    C3A -->|已关注| C3B[取消关注]
    C3A -->|未关注| C3C[关注用户]
    C3B --> C3D[更新关注状态]
    C3C --> C3D

    C4 --> M[私信页面]

    D --> D1[关注列表]
    D --> D2[粉丝列表]
    D1 --> D1A[用户列表]
    D2 --> D2A[用户列表]
    D1A --> A
    D2A --> A
```

## 5. 私信功能流程

```mermaid
graph TD
    A[私信页面] --> B{URL参数?}
    B -->|无userId| C[会话列表页]
    B -->|有userId| D[对话详情页]

    C --> C1[会话列表]
    C1 --> C1A[会话项]
    C1A --> C1B[用户头像/昵称]
    C1A --> C1C[最后消息预览]
    C1A --> C1D[未读消息徽章]
    C1A --> C1E[点击会话]
    C1E --> D

    D --> D1[对话历史]
    D --> D2[消息输入框]
    D --> D3[返回按钮]

    D1 --> D1A[消息列表]
    D1A --> D1B[文本消息]
    D1A --> D1C[歌曲分享卡片]

    D1C --> D1D[点击封面]
    D1C --> D1E[点击播放]
    D1D --> SD[歌曲详情页]
    D1E --> P[播放器]

    D2 --> D2A[输入消息]
    D2A --> D2B[点击发送]
    D2B --> D2C{互相关注?}
    D2C -->|是| D2D[发送消息]
    D2C -->|否| D2E[提示错误]
    D2D --> D2F[WebSocket推送]
    D2F --> D2G[更新消息列表]
    D2F --> D2H[更新对方未读数]

    D3 --> C
```

## 6. 分享功能流程

```mermaid
graph TD
    A[点击分享按钮] --> B[打开分享弹窗]
    B --> C[加载关注列表]
    C --> D[显示好友列表]

    D --> E[选择好友]
    E --> F[点击分享]
    F --> G{互相关注?}
    G -->|是| H[发送分享消息]
    G -->|否| I[提示错误]

    H --> J[构造分享内容]
    J --> K[歌曲信息JSON]
    K --> L[发送私信]
    L --> M[WebSocket推送]
    M --> N[对方收到分享]
    N --> O[显示歌曲卡片]

    F --> P[显示加载状态]
    L --> Q{发送成功?}
    Q -->|是| R[显示成功提示]
    Q -->|否| S[显示错误提示]
    R --> T[关闭弹窗]
```

## 7. 播放器流程

```mermaid
graph TD
    A[播放器组件] --> B[固定底部]
    B --> C[歌曲信息]
    B --> D[播放控制]
    B --> E[关闭按钮]

    C --> C1[封面]
    C --> C2[标题/歌手]

    D --> D1[播放/暂停]
    D --> D2[上一曲]
    D --> D3[下一曲]
    D --> D4[进度条]
    D --> D5[音量控制]

    D1 --> D1A{播放状态?}
    D1A -->|播放中| D1B[暂停]
    D1A -->|已暂停| D1C[播放]
    D1B --> D1D[更新UI]
    D1C --> D1D

    D2 --> D2A[切换到上一首]
    D2A --> D2B[更新当前歌曲]
    D2B --> D2C[自动播放]

    D3 --> D3A[切换到下一首]
    D3A --> D2B

    D4 --> D4A[拖动进度]
    D4A --> D4B[更新播放位置]

    D5 --> D5A[调整音量]
    D5A --> D5B[更新音量]

    E --> E1[停止播放]
    E1 --> E2[关闭播放器]
```

## 8. 个人资料页流程

```mermaid
graph TD
    A[个人资料页] --> B[显示当前信息]
    B --> C[编辑表单]

    C --> C1[昵称]
    C --> C2[简介]
    C --> C3[头像]
    C --> C4[手机号]
    C --> C5[密码]
    C --> C6[微信绑定]

    C3 --> C3A[点击上传]
    C3A --> C3B[选择图片]
    C3B --> C3C[上传到服务器]
    C3C --> C3D[更新头像URL]

    C5 --> C5A[输入旧密码]
    C5A --> C5B[输入新密码]
    C5B --> C5C[确认新密码]
    C5C --> C5D[提交修改]
    C5D --> C5E{验证成功?}
    C5E -->|是| C5F[更新密码]
    C5E -->|否| C5G[显示错误]

    C6 --> C6A{绑定状态?}
    C6A -->|已绑定| C6B[显示解绑按钮]
    C6A -->|未绑定| C6C[显示绑定按钮]
    C6B --> C6D[点击解绑]
    C6C --> C6E[跳转微信授权]
    C6D --> C6F[解绑微信]
    C6E --> C6G[获取OpenID]
    C6G --> C6H[绑定到账号]

    C --> D[保存按钮]
    D --> E[提交更新]
    E --> F{验证成功?}
    F -->|是| G[更新用户信息]
    F -->|否| H[显示错误]
    G --> I[显示成功提示]
    G --> J[刷新页面]
```

## 9. WebSocket实时通信流程

```mermaid
graph TD
    A[用户登录] --> B[建立WebSocket连接]
    B --> C[携带JWT Token]
    C --> D[服务器验证]
    D --> E{验证成功?}
    E -->|是| F[连接成功]
    E -->|否| G[拒绝连接]

    F --> H[监听事件]
    H --> H1[new_message]
    H --> H2[message_read]
    H --> H3[user_online]
    H --> H4[user_offline]

    H1 --> I[收到新消息]
    I --> J{当前页面?}
    J -->|消息页面| K[实时显示消息]
    J -->|其他页面| L[更新未读数徽章]
    K --> M[标记为已读]
    M --> N[发送read事件]

    H2 --> O[消息已读通知]
    O --> P[更新消息状态]

    H3 --> Q[好友上线]
    Q --> R[更新在线状态]

    H4 --> S[好友离线]
    S --> R

    T[发送消息] --> U[emit消息事件]
    U --> V[服务器处理]
    V --> W[保存到数据库]
    W --> X[推送给接收者]
    X --> I
```

## 10. 数据流向图

```mermaid
graph LR
    A[前端React] --> B[Redux Store]
    B --> C[API层]
    C --> D[Axios拦截器]
    D --> E[后端Flask]

    E --> F[JWT验证]
    F --> G[路由处理]
    G --> H[业务逻辑]
    H --> I[数据库SQLite]

    I --> J[返回数据]
    J --> H
    H --> G
    G --> E
    E --> D
    D --> C
    C --> B
    B --> A

    K[WebSocket] --> L[Socket.IO]
    L --> E
    E --> L
    L --> K
    K --> A
```

## 11. 页面导航关系图

```mermaid
graph TD
    A[登录页] --> B[首页]
    C[注册页] --> B
    D[微信回调页] --> B

    B --> E[歌曲详情页]
    B --> F[用户详情页]
    B --> G[私信页面]
    B --> H[个人资料页]

    E --> I[播放器]
    E --> G
    E --> F

    F --> G
    F --> H
    F --> F

    G --> J[会话列表]
    G --> K[对话详情]
    J --> K
    K --> E
    K --> F

    H --> B

    style B fill:#e1f5ff
    style E fill:#fff4e6
    style G fill:#f3e5f5
    style H fill:#e8f5e9
```

## 12. 权限控制流程

```mermaid
graph TD
    A[访问页面] --> B{需要登录?}
    B -->|否| C[直接访问]
    B -->|是| D{Token存在?}

    D -->|否| E[跳转登录页]
    D -->|是| F[验证Token]

    F --> G{Token有效?}
    G -->|是| H[允许访问]
    G -->|否| I{有RefreshToken?}

    I -->|是| J[刷新Token]
    I -->|否| E

    J --> K{刷新成功?}
    K -->|是| L[更新Token]
    K -->|否| E

    L --> H

    H --> M[API请求]
    M --> N[添加Token到Header]
    N --> O[发送请求]
    O --> P{响应状态?}

    P -->|200| Q[处理数据]
    P -->|401| R[Token过期]
    P -->|403| S[权限不足]
    P -->|其他| T[错误处理]

    R --> I
    S --> U[显示错误提示]
    T --> U
```

## 13. 移动端响应式适配流程

```mermaid
graph TD
    A[页面加载] --> B[检测屏幕宽度]
    B --> C{宽度判断}

    C -->|<576px| D[移动端布局]
    C -->|576-768px| E[平板布局]
    C -->|>768px| F[桌面端布局]

    D --> D1[单列布局]
    D --> D2[隐藏次要信息]
    D --> D3[图标按钮]
    D --> D4[全屏显示]
    D --> D5[底部导航]

    E --> E1[两列布局]
    E --> E2[部分信息]
    E --> E3[混合按钮]

    F --> F1[多列布局]
    F --> F2[完整信息]
    F --> F3[文字按钮]
    F --> F4[侧边栏]
    F --> F5[顶部导航]

    G[组件渲染] --> H[CSS媒体查询]
    H --> I[@media max-width: 768px]
    H --> J[@media min-width: 769px]

    I --> D
    J --> F
```

---

## 使用说明

这个文档包含了OnBeat应用的完整交互流程图，使用Mermaid语法编写。

**查看方式：**
1. 使用支持Mermaid的Markdown编辑器（如Typora）
2. 在VS Code中安装Mermaid插件
3. 在GitHub上直接查看（GitHub原生支持Mermaid）
4. 使用在线Mermaid编辑器：https://mermaid.live/

**流程图说明：**
- 矩形框：操作或状态
- 菱形框：判断条件
- 圆角矩形：页面或组件
- 箭头：流程方向
- 虚线：可选流程
